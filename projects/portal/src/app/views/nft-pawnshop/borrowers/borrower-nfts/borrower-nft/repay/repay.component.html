<div class="mb-4">
  <h2>Repay</h2>
</div>
<div class="card lg:card-side bg-base-100 shadow-xl mb-8">
  <figure class="aspect-square w-full">
    <img
      src="{{ nftImage || 'assets/UnUniFi-logo.png' }}"
      alt="image of the NFT"
      class="h-full object-cover"
    />
  </figure>
  <div class="card-body w-full lg:w-2/3">
    <div class="flex flex-row">
      <div class="badge badge-lg badge-primary">{{ listingInfo?.state }}</div>
    </div>
    <h2 class="card-title break-all">
      {{ nftMetadata?.name || classID + '/' + nftID }}
    </h2>
    <div class="overflow-x-auto">
      <table class="table w-full">
        <tbody>
          <tr>
            <th>Class ID</th>
            <td>{{ classID }}</td>
          </tr>
          <tr>
            <th>NFT ID</th>
            <td>{{ nftID }}</td>
          </tr>
          <tr>
            <th>Minimum deposit rate</th>
            <td>{{ listingInfo?.minimum_deposit_rate | percentage }}</td>
          </tr>
          <tr>
            <th>Started at</th>
            <td>{{ listingInfo?.started_at | date : 'yyyy-MM-dd a hh:mm:ss z' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="flex flex-col lg:flex-row mb-8">
  <div #chartCardRef class="card bg-base-100 shadow-xl w-full lg:w-2/3 mb-4 lg:mb-0 lg:mr-4">
    <h3 class="m-4 card-title">Borrowing</h3>
    <google-chart
      *ngIf="chartData"
      [title]="chartTitle"
      [type]="chartType"
      [data]="chartData"
      [columns]="chartColumns"
      [options]="chartOptions"
    >
    </google-chart>
  </div>

  <span class="flex-auto"></span>
  <div class="card bg-base-100 shadow-xl w-full lg:w-auto">
    <h3 class="m-4 card-title">Repay</h3>
    <div class="card-body">
      <form #formRef="ngForm" (submit)="onSubmit()">
        <div class="form-control">
          <span class="label">
            <span class="label-text">Enter repay amount</span>
            <!-- The button to open modal -->
            <label for="modal-bid-price"><mat-icon>help</mat-icon></label>

            <!-- Put this part before </body> tag -->
            <input type="checkbox" id="modal-bid-price" class="modal-toggle" />
            <div class="modal modal-bottom sm:modal-middle">
              <div class="modal-box">
                <h3 class="font-bold text-lg">What is the repay amount?</h3>
                <p class="py-4">
                  You must repay the borrowed tokens and interest by the repayment deadline. If you
                  are unable to repay, the NFT will be liquidated, but if there are other available
                  bids, refinancing will be carried out. Repayment will be made starting with the
                  highest interest rates.
                </p>
                <div class="modal-action">
                  <label for="modal-bid-price" class="btn">Understood</label>
                </div>
              </div>
            </div>
          </span>
          <label class="input-group">
            <input
              #repayAmountNgModelRef="ngModel"
              required
              type="number"
              name="amount"
              [(ngModel)]="repayAmount"
              [min]="0"
              [step]="1"
              class="input input-bordered w-full"
              [class]="{
                'input-error': repayAmountNgModelRef.errors && repayAmountNgModelRef.touched
              }"
              pattern="^[0-9]*\.?[0-9]{0,6}$"
            />
            <span>{{ repayDenom }}</span>
          </label>
        </div>

        <div class="stats stats-vertical md:stats-horizontals justify-end my-4">
          <div class="stat flex flex-col items-end">
            <div class="stat-title">Average interest rate</div>
            <div class="stat-value">{{ averageInterestRate | percentage }}</div>
            <div class="stat-desc"></div>
          </div>
          <div class="stat flex flex-col items-end">
            <div class="stat-title">Shortest expiry date</div>
            <div class="stat-value">{{ shortestExpiryDate | date : 'yyyy-MM-dd' }}</div>
            <div class="stat-desc">{{ shortestExpiryDate | date : 'a hh:mm:ss z' }}</div>
          </div>
        </div>

        <div class="flex flex-col md:flex-row justify-end">
          <button
            type="button"
            class="btn btn-primary btn-outline mb-2 md:-mb-2 md:mr-2 px-8"
            (click)="onSimulate()"
          >
            Simulate
          </button>
          <button class="btn btn-primary px-8" [disabled]="formRef.invalid">Repay</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div *ngIf="bidders?.length" class="card bg-base-100 shadow-xl">
  <div class="overflow-x-auto">
    <table class="table w-full">
      <thead>
        <tr>
          <th></th>
          <td>Interest</td>
          <td>Borrowing Amount</td>
          <td>Bid price</td>
          <td>Expiry</td>
          <td>Bidder</td>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let bidder of bidders; let i = index">
          <th>#{{ i + 1 }}</th>
          <td>{{ bidder.deposit_lending_rate | percentage }}</td>
          <td>{{ bidder.borrowings![0].amount | coin }}</td>
          <td>{{ bidder.bid_amount | coin }}</td>
          <td>{{ bidder.bidding_period | date : 'yyyy-MM-dd a hh:mm z' }}</td>
          <td>{{ bidder.bidder }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
